<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TradeTariffManager</title>
</head>
<body>
  <h1>Create Declaration</h1>
  <form id="declaration-form">
    <label>Product:
      <select id="product-select"></select>
    </label><br><br>
    <label>User:
      <select id="user-select"></select>
    </label><br><br>
    <label>Qty:
      <input type="number" id="quantity" min="1" value="1" required>
    </label><br><br>
    <label>Unit Cost:
      <input type="number" id="unitCost" step="0.01" value="0.00" required>
    </label><br><br>
    <label>Date:
      <input type="date" id="declarationDate" required>
    </label><br><br>
    <button type="submit">Create Declaration</button>
  </form>
  <pre id="result"></pre>
  <hr>
  <h2>All Declarations</h2>
  <table border="1" id="declarations-table">
    <thead><tr>
      <th>ID</th><th>Prod</th><th>User</th><th>Qty</th><th>Cost</th>
      <th>Due</th><th>Date</th><th>Status</th><th>Action</th>
    </tr></thead>
    <tbody></tbody>
  </table>

<script>
  const api = 'http://localhost:8000';

  // grab DOM elements **first**
  const pS = document.getElementById('product-select');
  const uS = document.getElementById('user-select');
  const qty = document.getElementById('quantity');
  const cS = document.getElementById('unitCost');
  const d  = document.getElementById('declarationDate');
  const resultPre = document.getElementById('result');

  async function loadOptions(){
    try {
      const [prods, users] = await Promise.all([
        fetch(`${api}/products`).then(r=>r.json()),
        fetch(`${api}/users`).then(r=>r.json())
      ]);
      prods.forEach(p => {
        pS.append(new Option(`${p.name} (HS ${p.hs_code})`, p.id));
      });
      users.forEach(u => {
        uS.append(new Option(`${u.email}`, u.id));
      });
    } catch(err) {
      console.error('Failed to load options', err);
    }
  }

  async function loadDeclarations(){
    try {
      const decls = await fetch(`${api}/declarations`).then(r=>r.json());
      const tb = document.querySelector('#declarations-table tbody');
      tb.innerHTML = '';
      decls.forEach(d => {
        const tr = tb.insertRow();
        tr.innerHTML = `
          <td>${d.id}</td>
          <td>${d.product_id}</td>
          <td>${d.user_id}</td>
          <td>${d.quantity}</td>
          <td>${d.unit_cost}</td>
          <td>${d.due}</td>
          <td>${d.declaration_date}</td>
          <td>${d.status}</td>
          <td>${
            d.status === 'submitted'
              ? `<button onclick="pay(${d.id})">Pay</button>`
              : ''
          }</td>
        `;
      });
    } catch(err) {
      console.error('Failed to load declarations', err);
    }
  }

  document.getElementById('declaration-form').onsubmit = async e => {
    e.preventDefault();
    try {
      const payload = {
        product_id: +pS.value,
        user_id:    +uS.value,
        quantity:   +qty.value,
        unit_cost:  +cS.value,
        declaration_date: d.value
      };
      const res = await fetch(`${api}/declarations`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const body = await res.json();
      resultPre.textContent = JSON.stringify(body, null, 2);
      await loadDeclarations();
    } catch(err) {
      console.error('Create failed', err);
    }
  };

  window.pay = async id => {
    try {
      await fetch(`${api}/declarations/${id}/pay`, {method:'POST'});
      await loadDeclarations();
    } catch(err) {
      console.error('Pay failed', err);
    }
  };

  // initialize
  loadOptions().then(loadDeclarations);
</script>
</body>
</html>
